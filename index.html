<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>REZA Luxury Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --gold-bright: #fff3a0;
            --bg: #050505;
            --card: rgba(20, 20, 25, 0.95);
            --danger: #ff4444;
            --input-bg: rgba(40, 30, 60, 0.6);
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: white; overflow: hidden;
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen {
            position: fixed; inset: 0; z-index: 9999; background: radial-gradient(circle at center, #1a1030, #050505);
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box {
            background: var(--card); border: 1px solid var(--gold); padding: 30px;
            border-radius: 25px; width: 100%; max-width: 400px; text-align: center;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.1);
        }
        .auth-box input {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px;
            border: 1px solid var(--gold); background: var(--input-bg); color: white; outline: none;
        }
        .auth-box input::placeholder { color: #aaa; }
        .btn-gold {
            background: linear-gradient(135deg, var(--gold), #8a6d3b);
            color: black; border: none; padding: 12px 30px; border-radius: 12px;
            font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;
        }

        /* Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„ÙŠÙƒÙˆÙ† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ */
        .app-container {
            display: flex; flex-direction: column; 
            height: 100vh; height: 100dvh; /* Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© */
            width: 100%;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø§ØªØµØ§Ù„ */
        .voice-header {
            background: rgba(0, 0, 0, 0.8); border-bottom: 1px solid var(--gold);
            padding: 10px 15px; display: flex; align-items: center; gap: 10px; overflow-x: auto;
        }
        .speaker-tag {
            background: var(--input-bg); border: 1px solid var(--gold);
            padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; white-space: nowrap;
        }
        .speaker-tag.active { border-color: #4ade80; box-shadow: 0 0 10px #4ade8055; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª */
        .main-content { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        #chat-flow {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px;
            background: url('https://www.transparenttextures.com/patterns/dark-matter.png');
        }

        /* Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª */
        .msg-container { max-width: 85%; position: relative; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .owner-tag {
            color: var(--gold); font-weight: bold; font-size: 0.8rem;
            text-shadow: 0 0 8px var(--gold); animation: shine 2s infinite;
        }
        @keyframes shine { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 15px var(--gold); } 100% { opacity: 0.8; } }

        .bubble {
            padding: 12px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(212,175,55,0.1);
        }
        .mine { align-self: flex-end; }
        .mine .bubble { background: linear-gradient(135deg, #2d1b4d, #1a1030); border-right: 3px solid var(--gold); }
        .others { align-self: flex-start; }

        .banned-msg { text-decoration: line-through; opacity: 0.5; color: var(--danger) !important; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .side-bar {
            width: 60px; background: rgba(0,0,0,0.5); border-left: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 25px;
        }
        .side-btn { font-size: 1.4rem; color: var(--gold); cursor: pointer; position: relative; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ - ØªØ¹Ø¯ÙŠÙ„ Ù„Ø±ÙØ¹Ù‡ Ù„Ù„Ø£Ø¹Ù„Ù‰ ÙˆÙ…Ù†Ø¹ Ø§Ø®ØªÙØ§Ø¦Ù‡ */
        .footer-bar {
            padding: 10px 15px 25px 15px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Øº Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ø±ÙØ¹Ù‡ */
            background: #000; display: flex; gap: 10px; align-items: center;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-bottom: calc(20px + env(safe-area-inset-bottom)); /* Ø¯Ø¹Ù… Ù†ÙˆØªØ´ Ø§Ù„Ø£ÙŠÙÙˆÙ† ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ */
        }
        #msg-input {
            flex: 1; background: var(--input-bg); border: 1px solid var(--gold);
            padding: 12px; border-radius: 15px; color: white; outline: none;
            font-size: 16px; /* Ù„Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙˆÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø£ÙŠÙÙˆÙ† */
        }
        .send-btn {
            background: var(--gold); color: black; width: 45px; height: 45px;
            border-radius: 12px; border: none; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª */
        .context-menu {
            position: fixed; background: #1a1a20; border: 1px solid var(--gold);
            border-radius: 12px; z-index: 10000; display: none; min-width: 160px; overflow: hidden;
        }
        .menu-item { padding: 12px 15px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover { background: var(--gold); color: black; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10001; display: none; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2 style="color:var(--gold)">REZA LUXURY</h2>
            <div id="auth-inputs">
                <input type="text" id="user-id" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Unique ID)">
                <input type="text" id="user-display" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±">
                <input type="password" id="user-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn-gold" onclick="attemptLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù…Ù„ÙƒØ©</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="voice-header" id="voice-header">
            <button class="btn-gold" id="btn-call" style="width:auto; padding:5px 15px"><i class="fas fa-phone"></i> Ø¯Ø®ÙˆÙ„</button>
            <button class="btn-gold" id="btn-exit-call" style="display:none; background:var(--danger); color:white; width:auto; padding:5px 15px">Ø®Ø±ÙˆØ¬</button>
            <div id="voice-users" style="display:flex; gap:8px"></div>
        </div>

        <div class="main-content">
            <div id="chat-flow"></div>

            <div class="side-bar">
                <i class="fas fa-user-circle side-btn" onclick="openProfile()"></i>
                <i class="fas fa-user-slash side-btn" onclick="showBannedList()"></i>
                <i class="fas fa-sign-out-alt side-btn" style="color:var(--danger)" onclick="location.reload()"></i>
            </div>
        </div>

        <div id="rep-preview" style="display:none; background:rgba(212,175,55,0.1); padding:5px 20px; font-size:0.8rem; border-top:1px solid var(--gold)">
            <span>Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰: <b id="rep-name"></b></span>
            <i class="fas fa-times" style="float:left" onclick="cancelReply()"></i>
        </div>

        <div class="footer-bar">
            <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
            <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="msg-menu" class="context-menu">
        <div class="menu-item" onclick="prepareReply()"><i class="fas fa-reply"></i> Ø±Ø¯</div>
        <div class="menu-item" onclick="viewProfile()"><i class="fas fa-address-card"></i> Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
        <div id="my-ops" style="display:none; border-top:1px solid #333">
            <div class="menu-item" onclick="startEdit()"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</div>
            <div class="menu-item" style="color:var(--danger)" onclick="deleteMsg()"><i class="fas fa-trash"></i> Ø­Ø°Ù</div>
        </div>
        <div id="admin-ops" style="display:none; border-top:1px solid #333">
            <div class="menu-item" style="color:var(--danger)" onclick="banUser()"><i class="fas fa-ban"></i> Ø­Ø¸Ø± (Ø§Ù„Ù…Ø§Ù„Ùƒ)</div>
        </div>
    </div>

    <div id="modal-p" class="modal" onclick="this.style.display='none'">
        <div class="auth-box" onclick="event.stopPropagation()">
            <i class="fas fa-crown" style="font-size:3rem; color:var(--gold)"></i>
            <h3 id="p-name"></h3>
            <p id="p-bio" style="color:#aaa"></p>
            <div id="my-edit-fields" style="display:none">
                <input type="text" id="new-name" placeholder="ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…">
                <textarea id="new-bio" style="width:100%; background:var(--input-bg); color:white; border:1px solid var(--gold); border-radius:12px; padding:10px" placeholder="Ø§Ù„Ø¨Ø§ÙŠÙˆ..."></textarea>
                <button class="btn-gold" onclick="updateMyProfile()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, query, limitToLast, remove, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBvGWF0u83mrdtBTLWgGV-ExuO6-4j-1Xk",
            authDomain: "reza-3d325.firebaseapp.com",
            databaseURL: "https://reza-3d325-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "reza-3d325"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let me = null, activeMsg = null, isEdit = false, replyData = null;
        let peer = null, localStream = null;

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        window.attemptLogin = async () => {
            const uid = document.getElementById('user-id').value.trim().toLowerCase();
            const name = document.getElementById('user-display').value.trim();
            const pass = document.getElementById('user-pass').value;

            if(!uid || !pass) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            const snap = await get(ref(db, 'users/' + uid));
            if(snap.exists()) {
                if(snap.val().isBanned) return alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø§Øª.");
                if(snap.val().pass === pass) {
                    me = snap.val();
                } else return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©");
            } else {
                me = { user: uid, name: name || uid, pass, bio: "Ø£Ù†Ø§ Ù‡Ù†Ø§ ÙÙŠ Ù…Ù…Ù„ÙƒØ© Ø±Ø¶Ø§", isOwner: uid === 'reza' };
                await set(ref(db, 'users/' + uid), me);
            }
            document.getElementById('auth-screen').style.display = 'none';
            startChat();
        };

        // --- Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
        function startChat() {
            onValue(query(ref(db, 'messages'), limitToLast(40)), snap => {
                const flow = document.getElementById('chat-flow');
                flow.innerHTML = '';
                snap.forEach(child => {
                    const m = child.val();
                    if(!m) return;
                    const isMine = m.uid === me.user;
                    const div = document.createElement('div');
                    div.className = `msg-container ${isMine ? 'mine' : 'others'}`;
                    
                    // ØªØµØ­ÙŠØ­ Ø§Ù„ÙˆÙ‚Øª Ù„ØªØ¬Ù†Ø¨ Invalid Date
                    let time = "";
                    if(m.time) {
                        const d = new Date(m.time);
                        time = isNaN(d) ? "" : d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    }
                    
                    div.innerHTML = `
                        <div style="font-size:0.7rem; margin-bottom:3px">
                            ${m.uid === 'reza' ? '<span class="owner-tag">Ø§Ù„Ù…Ø§Ù„Ùƒ ğŸ‘‘</span>' : ''}
                            <span style="color:#aaa">${m.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}</span>
                            <span style="font-size:0.6rem; opacity:0.5; margin-right:5px">${time}</span>
                        </div>
                        <div class="bubble ${m.banned ? 'banned-msg' : ''}" onclick="openMenu(event, '${child.key}', ${JSON.stringify(m).replace(/"/g, '&quot;')})">
                            ${m.reply ? `<div style="font-size:0.7rem; color:var(--gold); border-right:2px solid; padding-right:5px; margin-bottom:5px">Ø±Ø¯ Ø¹Ù„Ù‰ ${m.reply.name}: ${m.reply.txt}</div>` : ''}
                            ${m.txt || ''}
                            ${m.isEdited ? '<span style="font-size:0.6rem; opacity:0.5"> (Ù…ÙØ¹Ø¯Ù„Ø©)</span>' : ''}
                        </div>
                    `;
                    flow.appendChild(div);
                });
                flow.scrollTop = flow.scrollHeight;
            });
        }

        window.sendMessage = () => {
            const txt = document.getElementById('msg-input').value.trim();
            if(!txt) return;

            if(isEdit) {
                update(ref(db, `messages/${activeMsg.id}`), { txt, isEdited: true });
                isEdit = false;
                activeMsg = null;
            } else {
                const data = { uid: me.user, name: me.name, txt, time: serverTimestamp() };
                if(replyData) data.reply = replyData;
                push(ref(db, 'messages'), data);
            }
            document.getElementById('msg-input').value = '';
            cancelReply();
        };

        // --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ---
        window.openMenu = (e, id, m) => {
            activeMsg = { id, ...m };
            const menu = document.getElementById('msg-menu');
            menu.style.display = 'block';
            menu.style.top = e.clientY + 'px';
            menu.style.left = e.clientX + 'px';

            document.getElementById('my-ops').style.display = (m.uid === me.user) ? 'block' : 'none';
            document.getElementById('admin-ops').style.display = (me.user === 'reza' && m.uid !== 'reza') ? 'block' : 'none';
        };

        window.startEdit = () => {
            isEdit = true;
            document.getElementById('msg-input').value = activeMsg.txt || "";
            document.getElementById('msg-input').focus();
            closeMenu();
        };

        window.deleteMsg = () => {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) {
                remove(ref(db, `messages/${activeMsg.id}`));
            }
            closeMenu();
        };

        window.banUser = async () => {
            if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø¸Ø± ${activeMsg.name}ØŸ`)) {
                await update(ref(db, `users/${activeMsg.uid}`), { isBanned: true });
                alert(`ØªÙ… Ø­Ø¸Ø± ${activeMsg.name} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹`);
            }
            closeMenu();
        };

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø·ÙˆØ± ---
        document.getElementById('btn-call').onclick = async () => {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                peer = new Peer(me.user);
                
                peer.on('open', () => {
                    set(ref(db, `voice_active/${me.user}`), { name: me.name });
                    document.getElementById('btn-call').style.display = 'none';
                    document.getElementById('btn-exit-call').style.display = 'block';
                });

                peer.on('call', call => {
                    call.answer(localStream);
                    setupAudio(call);
                });

                const snap = await get(ref(db, 'voice_active'));
                if(snap.exists()) {
                    snap.forEach(child => {
                        if(child.key !== me.user) {
                            const call = peer.call(child.key, localStream);
                            setupAudio(call);
                        }
                    });
                }

                onValue(ref(db, 'voice_active'), s => {
                    const box = document.getElementById('voice-users');
                    box.innerHTML = '';
                    s.forEach(c => {
                        box.innerHTML += `<div class="speaker-tag active">${c.val().name}</div>`;
                    });
                });
            } catch(e) { alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§ÙŠÙƒ"); }
        };

        function setupAudio(call) {
            call.on('stream', stream => {
                const audio = new Audio();
                audio.srcObject = stream;
                audio.autoplay = true;
                audio.play(); 
            });
        }

        document.getElementById('btn-exit-call').onclick = () => {
            remove(ref(db, `voice_active/${me.user}`));
            if(peer) peer.destroy();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            location.reload();
        };

        window.closeMenu = () => document.getElementById('msg-menu').style.display = 'none';
        window.prepareReply = () => { replyData = { name: activeMsg.name, txt: activeMsg.txt }; document.getElementById('rep-preview').style.display = 'block'; document.getElementById('rep-name').innerText = activeMsg.name; closeMenu(); };
        window.cancelReply = () => { replyData = null; document.getElementById('rep-preview').style.display = 'none'; };
        window.openProfile = () => { 
            document.getElementById('modal-p').style.display = 'flex'; 
            document.getElementById('p-name').innerText = me.name;
            document.getElementById('p-bio').innerText = me.bio || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø§ÙŠÙˆ";
            document.getElementById('my-edit-fields').style.display = 'block';
        };
        document.addEventListener('click', e => { if(!e.target.closest('.bubble')) closeMenu(); });
    </script>
</body>
</html>
